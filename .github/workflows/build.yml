name: Build Client EXE

on:
  push:
    paths:
      - 'client.py'
    branches:
      - main
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v2.3.0)'
        required: false
        default: ''

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install aiohttp aiofiles requests psutil cryptography pywin32
        
        # Additional dependencies that might be needed
        pip install pillow pypdf2 pymupdf reportlab urllib3 certifi
        
        echo "‚úÖ All dependencies installed successfully"

    - name: Verify client.py exists
      run: |
        if (Test-Path "client.py") {
          echo "‚úÖ client.py found"
          $size = (Get-Item "client.py").Length
          echo "üìÑ File size: $([math]::Round($size / 1KB, 2)) KB"
        } else {
          echo "‚ùå client.py not found!"
          echo "üìÅ Current directory contents:"
          Get-ChildItem
          exit 1
        }
      shell: pwsh

    - name: Generate version
      id: version
      run: |
        if ("${{ github.event.inputs.version }}" -ne "") {
          echo "VERSION=${{ github.event.inputs.version }}" >> $env:GITHUB_OUTPUT
          echo "üè∑Ô∏è Using manual version: ${{ github.event.inputs.version }}"
        } else {
          $date = Get-Date -Format "yyyy.MM.dd"
          $run = "${{ github.run_number }}"
          $version = "v$date.$run"
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
          echo "üè∑Ô∏è Auto-generated version: $version"
        }
      shell: pwsh

    - name: Update version in client.py
      run: |
        if (Test-Path "client.py") {
          $content = Get-Content client.py -Raw -Encoding UTF8
          
          # Show current version before update
          if ($content -match 'VERSION\s*=\s*"([^"]*)"') {
            echo "üìã Current version in file: $($matches[1])"
          }
          
          # Update version strings
          $content = $content -replace 'VERSION\s*=\s*"[^"]*"', 'VERSION = "${{ steps.version.outputs.VERSION }}"'
          $content = $content -replace '__version__\s*=\s*"[^"]*"', '__version__ = "${{ steps.version.outputs.VERSION }}"'
          
          Set-Content client.py $content -Encoding UTF8
          
          # Verify update
          $updatedContent = Get-Content client.py -Raw -Encoding UTF8
          if ($updatedContent -match 'VERSION\s*=\s*"([^"]*)"') {
            echo "‚úÖ Updated version in file: $($matches[1])"
          }
        } else {
          echo "‚ùå client.py not found for version update!"
          exit 1
        }
      shell: pwsh

    - name: Build EXE with PyInstaller
      run: |
        echo "üöÄ Building executable..."
        echo "üìã PyInstaller version:"
        pyinstaller --version
        
        $exeName = "PDF-Metadata-Tool-${{ steps.version.outputs.VERSION }}"
        echo "üèóÔ∏è Building: $exeName"
        
        # Build with detailed output
        pyinstaller --onefile `
          --name $exeName `
          --windowed `
          --hidden-import=aiohttp `
          --hidden-import=aiofiles `
          --hidden-import=asyncio `
          --hidden-import=requests `
          --hidden-import=psutil `
          --hidden-import=cryptography `
          --hidden-import=pkg_resources.extern `
          --hidden-import=win32api `
          --hidden-import=win32con `
          --hidden-import=win32gui `
          --hidden-import=pywintypes `
          --hidden-import=win32file `
          --hidden-import=win32security `
          --hidden-import=PIL `
          --hidden-import=pypdf2 `
          --hidden-import=fitz `
          --hidden-import=urllib3 `
          --hidden-import=certifi `
          --collect-submodules=cryptography `
          --collect-submodules=win32api `
          --console `
          client.py
          
        if ($LASTEXITCODE -ne 0) {
          echo "‚ùå PyInstaller failed with exit code: $LASTEXITCODE"
          exit 1
        }
        
        # Verify build succeeded
        $exePath = "dist/$exeName.exe"
        if (Test-Path $exePath) {
          $size = (Get-Item $exePath).Length
          $sizeMB = [math]::Round($size / 1MB, 2)
          echo "‚úÖ Build successful! File: $exePath"
          echo "üìä File size: $sizeMB MB"
        } else {
          echo "‚ùå Build failed - executable not found!"
          echo "üìÅ Contents of dist directory:"
          if (Test-Path "dist") {
            Get-ChildItem "dist"
          } else {
            echo "dist directory does not exist"
          }
          exit 1
        }
      shell: pwsh

    - name: Test executable
      run: |
        $exePath = "dist/PDF-Metadata-Tool-${{ steps.version.outputs.VERSION }}.exe"
        
        if (Test-Path $exePath) {
          # Test that the file is a valid PE executable
          $signature = Get-Content $exePath -Encoding Byte -TotalCount 2
          if ($signature[0] -eq 77 -and $signature[1] -eq 90) {
            echo "‚úÖ Valid executable format confirmed"
          } else {
            echo "‚ùå Invalid executable format"
            exit 1
          }
          
          # Additional file verification
          $fileInfo = Get-Item $exePath
          echo "üìã File details:"
          echo "   Size: $([math]::Round($fileInfo.Length / 1MB, 2)) MB"
          echo "   Created: $($fileInfo.CreationTime)"
        } else {
          echo "‚ùå Executable not found for testing!"
          exit 1
        }
      shell: pwsh

    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.version.outputs.VERSION }}
        release_name: PDF Metadata Tool ${{ steps.version.outputs.VERSION }}
        body: |
          ## üöÄ PDF Metadata Tool ${{ steps.version.outputs.VERSION }}
          
          ### üìä Build Information
          - **Version:** ${{ steps.version.outputs.VERSION }}
          - **Built on:** ${{ github.event.head_commit.timestamp }}
          - **Commit:** [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
          - **Build #:** ${{ github.run_number }}
          - **Trigger:** ${{ github.event_name }}
          
          ### üîß Installation Instructions
          1. üì• Download the executable file below
          2. üèÉ Run the application (no installation required)
          3. üîë Enter your license key when prompted
          4. ‚úÖ Start using the PDF Metadata Tool!
          
          ### üîÑ Auto-Update Feature
          The application automatically checks for updates on startup and will notify you when new versions are available.
          
          ### üõ°Ô∏è System Requirements
          - Windows 10/11 (64-bit recommended)
          - No additional software installation required
          - Valid license key from your license provider
          
          ### üìû Support
          For technical support or license issues, please contact your license provider or visit the license management portal.
        draft: false
        prerelease: false

    - name: Upload Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./dist/PDF-Metadata-Tool-${{ steps.version.outputs.VERSION }}.exe
        asset_name: PDF-Metadata-Tool-${{ steps.version.outputs.VERSION }}.exe
        asset_content_type: application/octet-stream

    - name: Notify License Server
      run: |
        $body = @{
          version = "${{ steps.version.outputs.VERSION }}"
          download_url = "https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.VERSION }}/PDF-Metadata-Tool-${{ steps.version.outputs.VERSION }}.exe"
          release_date = Get-Date -Format "yyyy-MM-dd'T'HH:mm:ss'Z'"
          build_number = "${{ github.run_number }}"
          commit_sha = "${{ github.sha }}"
          filename = "PDF-Metadata-Tool-${{ steps.version.outputs.VERSION }}.exe"
          release_url = "https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.VERSION }}"
        } | ConvertTo-Json -Depth 3
        
        # Try multiple notification endpoints for robustness
        $notification_endpoints = @()
        
        # Primary server URL from secrets
        if ("${{ secrets.LICENSE_SERVER_URL }}" -ne "") {
          $notification_endpoints += "${{ secrets.LICENSE_SERVER_URL }}/api/release-notification"
        }
        
        # Backup/alternative server URLs (customize these)
        $notification_endpoints += @(
          "https://pdf-license-server-dmyx.onrender.com/api/release-notification"
        )
        
        $headers = @{
          "Content-Type" = "application/json"
          "User-Agent" = "GitHub-Actions-PDF-Builder/1.0"
        }
        
        # Add webhook secret if available
        if ("${{ secrets.WEBHOOK_SECRET }}" -ne "") {
          $headers["X-GitHub-Token"] = "${{ secrets.WEBHOOK_SECRET }}"
        }
        
        $notification_success = $false
        
        foreach ($endpoint in $notification_endpoints) {
          if ($endpoint -eq "") { continue }
          
          echo "üîî Notifying license server: $endpoint"
          
          try {
            $response = Invoke-RestMethod -Uri $endpoint -Method POST -Body $body -Headers $headers -TimeoutSec 30
            echo "‚úÖ Successfully notified license server!"
            echo "üìã Response: $($response | ConvertTo-Json -Compress)"
            $notification_success = $true
            break
          } catch {
            echo "‚ö†Ô∏è Failed to notify $endpoint : $($_.Exception.Message)"
            continue
          }
        }
        
        if (-not $notification_success) {
          echo "‚ö†Ô∏è Could not notify license server - build is still successful"
          echo "‚ÑπÔ∏è Manual notification may be required"
        }
        
        echo ""
        echo "üéâ BUILD SUMMARY:"
        echo "================="
        echo "‚úÖ Version: ${{ steps.version.outputs.VERSION }}"
        echo "‚úÖ Download: https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.VERSION }}/PDF-Metadata-Tool-${{ steps.version.outputs.VERSION }}.exe"
        echo "‚úÖ Release: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.VERSION }}"
        if ($notification_success) {
          echo "‚úÖ License server notified"
        } else {
          echo "‚ö†Ô∏è License server notification failed (non-critical)"
        }
      shell: pwsh
